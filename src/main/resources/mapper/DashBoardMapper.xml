<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.minbak.web.dash_board.DashBoardMapper">

    <!-- 유저 신고 미해결 건수 조회 -->
    <select id="countUserReports" resultType="int">
        SELECT COUNT(*)
        FROM user_reports
        WHERE status = '대기'
    </select>

    <!-- 숙소 신고 미해결 건수 조회 -->
    <select id="countRoomReports" resultType="int">
        SELECT COUNT(*)
        FROM rooms_reports
        WHERE status = 'PENDING'
    </select>

    <!-- 호스트 인증 신청 건수 조회 (is_verified = 0 인 경우) -->
    <select id="countHostVerifications" resultType="int">
        SELECT COUNT(*)
        FROM host
        WHERE is_verified = '검증 중'
    </select>

    <!-- 전체 유저 수 조회 -->
    <select id="countTotalUsers" resultType="int">
        SELECT COUNT(*) FROM users;
    </select>

    <!-- 호스트 유저 수 조회 -->
    <select id="countHosts" resultType="int">
        SELECT COUNT(*) FROM users_roles WHERE role_id = 2;
    </select>

    <!--지금으로부터 5개월까지의 예약 데이터 개수 가져오기-->
    <select id="findMonthlyReservations" resultType="com.minbak.web.dash_board.MonthlyReservationDto">
        SELECT DATE_FORMAT(start_date, '%Y-%m') AS month,
        COUNT(*) AS book_count
        FROM books
        WHERE start_date >= LAST_DAY(DATE_SUB(NOW(), INTERVAL 5 MONTH)) + INTERVAL 1 DAY
        AND  LAST_DAY(DATE_ADD(NOW(), INTERVAL 1 MONTH)) + INTERVAL 1 DAY > start_date
        GROUP BY month
        ORDER BY month;
    </select>


    <!-- 월별 매출 데이터 조회 -->
    <select id="findMonthlyRevenue" resultType="com.minbak.web.dash_board.MonthlyRevenueDto">
        SELECT DATE_FORMAT(paid_at, '%Y-%m') AS month,
        SUM(amount) AS revenue
        FROM payments
        WHERE paid_at >= LAST_DAY(DATE_SUB(NOW(), INTERVAL 5 MONTH)) + INTERVAL 1 DAY
        AND LAST_DAY(NOW()) + INTERVAL 1 DAY > paid_at
            AND status = '결제 완료'  <!-- 결제 완료된 건만 포함 -->
        GROUP BY month
        ORDER BY month;
    </select>

    <!-- 전체 숙소 수 -->
    <select id="countTotalRooms" resultType="int">
        SELECT COUNT(*) FROM rooms;
    </select>

    <!-- 오늘 가입한 사용자 수 -->
    <select id="countTodayUsers" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE DATE(created_at) = CURDATE();
    </select>

    <!-- 총 매출 (결제 완료된 금액 합산) -->
    <select id="sumTotalRevenue" resultType="decimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM payments
        WHERE status = '결제 완료';
    </select>

    <!-- 미처리 신고 건수 -->
    <select id="countPendingReports" resultType="int">
        SELECT COUNT(*)
        FROM user_reports
        WHERE status = '대기';
    </select>

    <!-- 리뷰 평균 점수 -->
    <select id="avgReviewScore" resultType="decimal">
        SELECT COALESCE(AVG(score), 0)
        FROM review;
    </select>

    <!-- 최근 신고된 숙소 최신순 5개 조회 -->
    <select id="findRecentReportedRooms" resultType="com.minbak.web.dash_board.ReportedRoomDto">
        SELECT
        u.user_id,
        u.email AS user_email,
        r.room_id,
        r.name AS room_name,
        r.address,
        r.price
        FROM rooms_reports rr
        JOIN rooms r ON rr.room_id = r.room_id
        JOIN users u ON r.user_id = u.user_id
        ORDER BY rr.report_id DESC
        LIMIT 4
    </select>

    <!-- 전체 예약 건수 조회 -->
    <select id="countTotalReservations" resultType="int">
        SELECT COUNT(*) FROM books;
    </select>

    <!-- 취소된 예약 건수 조회 (취소 상태: '이용자 취소', '숙박업자 취소') -->
    <select id="countCancelledReservations" resultType="int">
        SELECT COUNT(*)
        FROM books
        WHERE status IN ('이용자 취소', '숙박업자 취소');
    </select>

    <!-- 관리자 리스트 조회 -->
    <select id="findAllAdmins" resultType="com.minbak.web.dash_board.AdminDto">
        SELECT u.user_id AS id, u.email, u.phone_number AS phoneNumber
        FROM users u
        JOIN users_roles ur ON u.user_id = ur.user_id
        JOIN roles r ON ur.role_id = r.role_id
        WHERE r.role = 'ROLE_ADMIN';
    </select>

    <!-- 카테고리별 숙소 개수 조회 (상위 8개) -->
    <select id="countRoomsByCategory" resultType="com.minbak.web.dash_board.CategoryRoomCountDto">
        SELECT c.name AS categoryName, COUNT(rc.room_id) AS roomCount
        FROM categories c
        LEFT JOIN rooms_categories rc ON c.category_id = rc.category_id
        GROUP BY c.category_id
        ORDER BY roomCount DESC
        LIMIT 8;
    </select>


    <!-- 옵션별 숙소 개수 조회 -->
    <select id="countRoomsByOption" resultType="com.minbak.web.dash_board.OptionRoomCountDto">
        SELECT o.name AS optionName, COUNT(rro.room_id) AS roomCount
        FROM room_options o
        LEFT JOIN rooms_room_options rro ON o.option_id = rro.option_id
        GROUP BY o.option_id
        ORDER BY roomCount DESC;
    </select>

    <insert id="insertMessage" parameterType="com.minbak.web.messages.MessageDto">
        INSERT INTO message (sender_id, receiver_id, content)
        VALUES (#{senderId}, #{receiverId}, #{content});
    </insert>

</mapper>