<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.minbak.web.review.ReviewMapper">

        <!-- 리뷰 목록 조회 -->
        <select id="findAllReview" resultType="com.minbak.web.review.ReviewDto">
            SELECT * FROM review
        </select>

        <!-- 페이지네이션을 적용하여 리뷰 목록 가져오기 -->
        <select id="findReviewsWithPagination" resultType="com.minbak.web.review.ReviewDto">
            SELECT review.*, users.email FROM review
            JOIN users ON review.user_id = users.user_id
            ORDER BY review_id DESC  <!-- 최신 리뷰가 먼저 보이도록 정렬 -->
            LIMIT #{limit} OFFSET #{offset};  <!-- 페이지네이션 적용 -->

        </select>

    <!-- 검색어에 맞는 총 후기 수를 가져오는 쿼리 -->
    <select id="selectTotalReviewCount" resultType="Integer">
        SELECT COUNT(*) FROM review
        WHERE content LIKE CONCAT('%', #{search}, '%')  <!-- 리뷰 내용에서 검색어를 포함한 항목들만 찾기 -->
    </select>

    <!-- 검색어에 맞는 리뷰 리스트를 가져오는 쿼리 -->
    <select id="selectReviews" resultType="com.minbak.web.review.ReviewDto">
        SELECT *
        FROM review
        WHERE content LIKE CONCAT('%', #{search}, '%')  <!-- 리뷰 내용에서 검색어를 포함한 항목들만 찾기 -->
        ORDER BY created_at DESC  <!-- 최신순으로 정렬 -->
        LIMIT 5  <!-- 최대 5개만 반환 -->
    </select>

        <!-- 리뷰 상세 조회 (특정 리뷰 조회) -->
        <select id="findReviewById" resultType="com.minbak.web.review.ReviewDto">
            SELECT review.*, users.email FROM review
            JOIN users ON review.user_id = users.user_id
            WHERE review_id = #{reviewId}
        </select>



        <!-- 리뷰 수정 -->
        <update id="editReview">
            UPDATE review
            SET
            content = #{content},
            score = #{score}
            <!--        updated_at = NOW()-->
            WHERE review_id = #{reviewId}
        </update>

        <!-- 리뷰 삭제 -->
        <delete id="deleteReview">
            DELETE FROM review
            WHERE review_id = #{reviewId}
        </delete>

    </mapper>