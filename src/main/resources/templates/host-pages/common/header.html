<!-- ì ìš©ë°©ì‹ : <div th:replace="~{user-pages/common/header}"></div> -->

<!-- css -->
<link rel="stylesheet" href="/css/header.css">
<!-- âœ… í—¤ë” -->
<div class="header">
  <a href="/">
    <img src="/uploads/logo-text.png" alt="ë¡œê³ " height="40"> <!-- ë¡œê³  -->
  </a>

  <div class="menu">
    <a href="/host/today" class="nav-link">íˆ¬ë°ì´</a>
    <a href="/host/room/list" class="nav-link">ìˆ™ì†Œ</a>
    <a href="/user/messageList" class="nav-link">ë©”ì‹œì§€</a>
    <a href="/host/books" class="nav-link">ì˜ˆì•½</a>
    <a href="#" class="nav-link">í˜¸ìŠ¤íŒ… ìˆ˜ì…</a>
    <a href="/user/create-rooms" class="nav-link text-primary">ìƒˆë¡œìš´ ìˆ™ì†Œ ë“±ë¡í•˜ê¸°</a>
  </div>

  <!--ë©”ì‹œì§€ ì¡´ì¬í•˜ë©´ ì–¼ëŸ¿-->
  <div th:if="${message}" class="alert alert-success" role="alert">
    <span th:text="${message}"></span>
  </div>

  <!-- âœ… ìš°ì¸¡ ìœ ì € ì •ë³´ -->
  <div class="user-menu">

    <!-- âœ… ìœ ì € ì •ë³´ê°€ ìˆì„ ë•Œ -->
    <div th:if="${headerUser != null}" class="d-flex align-items-center gap-3">
      <!-- âœ… í˜¸ìŠ¤íŠ¸ ì—¬ë¶€ì— ë”°ë¥¸ ë™ì  ë§í¬ -->
      <div th:if="${headerUser != null}">
        <a th:href="${headerUser.isHost} ? '/host/today' : '/host/room/create'"
           class="btn btn-outline-primary">
          <span th:text="${headerUser.isHost} ? 'í˜¸ìŠ¤íŠ¸ ëª¨ë“œ ì „í™˜' : 'ìˆ™ì†Œ ë“±ë¡í•˜ê¸°'"></span>
        </a>
      </div>
      <button class="btn btn-light">ğŸ”” ì•Œë¦¼</button>
      <img th:src="${headerUser.profileImageUrl != null} ? ${headerUser.profileImageUrl} : '/uploads/3966f510-65f8-46e7-af79-5f23ae159e6b_user-1.png'"
           alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-img">


      <span th:text="${headerUser.name}">ì‚¬ìš©ì ì´ë¦„</span>

      <!-- âœ… ë¶€íŠ¸ìŠ¤íŠ¸ë© ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì¶”ê°€ -->
      <div class="dropdown">
        <button class="btn btn-warning dropdown-toggle" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          ë©”ë‰´
        </button>
        <ul class="dropdown-menu" aria-labelledby="userMenuDropdown">
          <li><a class="dropdown-item" href="/user/book/list">ë‚´ ì˜ˆì•½</a></li>
          <li><a class="dropdown-item" href="#">ë‚´ í”„ë¡œí•„</a></li>
          <li><a class="dropdown-item" href="/">ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜</a></li>
          <li><a class="dropdown-item" href="#">ì„¤ì •</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <button class="dropdown-item text-danger" id="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
          </li>



        </ul>
      </div>
    </div>

    <!-- âœ… ìœ ì € ì •ë³´ê°€ ì—†ì„ ë•Œ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ -->
    <div th:if="${headerUser == null}">
      <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
      <div class="text-center">
        <button id="openLoginModal" class="btn btn-warning">ë¡œê·¸ì¸</button>
      </div>

      <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
      <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">ë¡œê·¸ì¸</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="email" class="form-label">ì´ë©”ì¼</label>
                  <input type="email" class="form-control" id="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                  <input type="password" class="form-control" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <p id="loginError" class="text-danger text-center"></p>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              <a href="/signup" class="btn btn-success">íšŒì›ê°€ì…</a> <!-- âœ… íšŒì›ê°€ì… ë²„íŠ¼ ì¶”ê°€ -->
              <button type="button" class="btn btn-primary" id="loginBtn">ë¡œê·¸ì¸</button>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>
</div>


<!--ë¡œê·¸ì¸ëª¨ë‹¬-->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const loginModalElement = document.getElementById("loginModal");
    const loginModal = new bootstrap.Modal(loginModalElement);
    const openModalBtn = document.getElementById("openLoginModal");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");

    if (!loginModalElement) {
        console.error("âŒ loginModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    if (!openModalBtn) {
        console.error("âŒ ë¡œê·¸ì¸ ë²„íŠ¼(#openLoginModal)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }


    // âœ… ì„œë²„ì—ì„œ ë Œë”ë§í•œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const user = /*[[${headerUser}]]*/ null; // Thymeleafì—ì„œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°


    console.log("Thymeleafì—ì„œ ë°›ì€ ì‚¬ìš©ì ì •ë³´:", user);

    // âœ… ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    openModalBtn.addEventListener("click", function() {
        console.log("ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ í´ë¦­ë¨!");
        loginModal.show(); // ëª¨ë‹¬ ì—´ê¸°
    });

    // ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ & UI ì—…ë°ì´íŠ¸
    function checkAuth() {
      if (user) {
        openModalBtn.classList.add("d-none");
        logoutBtn.classList.remove("d-none");
      } else {
        openModalBtn.classList.remove("d-none");
        logoutBtn.classList.add("d-none");
      }
    }

    // ğŸ”¹ ë¡œê·¸ì¸ ìš”ì²­
    loginBtn.addEventListener("click", async function() {
      const username = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      console.log("ë¡œê·¸ì¸ ìš”ì²­ ì‹œì‘", username, password);

      const response = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      console.log("ì„œë²„ ì‘ë‹µ:", response.status);

      if (response.ok) {
        loginModal.hide();
        location.reload(); // âœ… ë¡œê·¸ì¸ ì„±ê³µ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ Thymeleaf ë³€ìˆ˜ ë°˜ì˜
      } else {
        console.log("ë¡œê·¸ì¸ ì‹¤íŒ¨!");
        loginError.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨! ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      }
    });

    // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ (ì„œë²„ì—ì„œ ì„¸ì…˜ ì œê±°)
    logoutBtn.addEventListener("click", async function() {
      console.log("ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰");

      await fetch("/api/logout", { method: "POST" });
      location.reload(); // âœ… ë¡œê·¸ì•„ì›ƒ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ UI ì—…ë°ì´íŠ¸
    });

    checkAuth(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  });
</script>
<script>
  document.getElementById("logout-button").addEventListener("click", function(event) {
      event.preventDefault(); // ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë°©ì§€

      fetch("/api/logout", {
          method: "POST", // RESTful ì›ì¹™ì— ë§ê²Œ POST ì‚¬ìš©
          credentials: "include" // ì¿ í‚¤ í¬í•¨í•˜ì—¬ ìš”ì²­ (JWT, ì„¸ì…˜ ì‚¬ìš© ì‹œ í•„ìš”)
      })
      .then(response => response.json())
      .then(data => {
          alert(data.message); // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          window.location.href = "/"; // ë¡œê·¸ì•„ì›ƒ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      })
      .catch(error => {
          console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
          alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  });
</script>