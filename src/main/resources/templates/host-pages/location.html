<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Maps with Search and Icon</title>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA50X20VvIVk9sELnewUrtok0ZJYWrtVzE&libraries=places&callback=initMap" async defer></script>
  <!-- FontAwesome (for the search icon) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* ì „ì²´ í˜ì´ì§€ ë ˆì´ì•„ì›ƒ */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    #map {
    width: 800px;
    height: 800px;
    margin: 0 auto;
    display: block;
}

    /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
    .search-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        width: 400px;
        display: flex;
        align-items: center;
        background-color: white;
        border-radius: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .search-container input {
        width: 100%;
        padding: 10px;
        padding-left: 35px; /* ì•„ì´ì½˜ì„ ìœ„í•œ ì—¬ë°± */
        border: none;
        border-radius: 25px;
        font-size: 16px;
        box-sizing: border-box;
    }

    .search-container i {
        position: absolute;
        left: 10px; /* ì•„ì´ì½˜ ìœ„ì¹˜ */
        font-size: 20px;
        color: #777;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .current-location-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .current-location-btn:hover {
        background-color: #0056b3;
    }

    #address-info {
        display: none;
        position: absolute;
        top: 80px;
        right: 150px;
        width: 300px;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
}
     #address-info label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
    }
    #address-info input {
        width: 100%;
        padding: 5px;
        font-size: 14px;
        margin-top: 2px;
    }

     /* ë‹¤ìŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ìˆ™ì†Œ ìœ í˜• ì„ íƒ í˜ì´ì§€ì™€ ë™ì¼) */
    .next-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #ff9800;
      border: none;
      padding: 15px 30px;
      font-size: 1.2rem;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      z-index: 10;
    }
    .next-btn:hover {
      background-color: #e68900;
    }
  </style>
</head>
<body>
<!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
<button class="current-location-btn" onclick="getCurrentLocation()">í˜„ì¬ ìœ„ì¹˜ ì •ë³´</button>

<!-- ì§€ë„ -->
<div id="map"></div>

<!-- ê²€ìƒ‰ì°½ -->
<div class="search-container">
  <i class="fas fa-search"></i> <!-- ê²€ìƒ‰ ì•„ì´ì½˜ -->
  <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
</div>

<!-- ì£¼ì†Œ ì„¸ë¶€ ì •ë³´ -->
<div id="address-info">
  <label>ë„/íŠ¹ë³„-ê´‘ì—­ì‹œ: <input type="text" id="province"></label>
  <label>ë„ì‹œ: <input type="text" id="city"></label>
  <label>êµ°/êµ¬: <input type="text" id="district"></label>
  <label>ë„ë¡œëª… ì£¼ì†Œ: <input type="text" id="road-address"></label>
  <label>ì•„íŒŒíŠ¸ ì¸µìˆ˜/í˜¸ìˆ˜: <input type="text" id="apartment"></label>
  <label>ê±´ë¬¼ëª…: <input type="text" id="building-name"></label>
  <label>ìš°í¸ë²ˆí˜¸: <input type="text" id="postal-code"></label>
</div>

<!-- ë‹¤ìŒ ë²„íŠ¼ -->
<a href="/host/floor-plan" class="next-btn">ë‹¤ìŒ</a>
<script >
  let map, marker, autocomplete;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 37.5665, lng: 126.9788 },
    zoom: 15,
  });

  marker = new google.maps.Marker({
    map: map,
    position: { lat: 37.5665, lng: 126.9788 },
    title: "í˜„ì¬ ìœ„ì¹˜",
  });

  // Autocomplete (Google Places API)
  autocomplete = new google.maps.places.Autocomplete(document.getElementById("address"), {
    fields: ["address_components", "geometry"],
  });

  autocomplete.addListener("place_changed", function () {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;

    map.setCenter(place.geometry.location);
    marker.setPosition(place.geometry.location);
    displayAddressInfo(place);
  });

  // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
  map.addListener('click', function (event) {
    marker.setPosition(event.latLng);
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: event.latLng }, function (results, status) {
      if (status === google.maps.GeocoderStatus.OK) {
        displayAddressInfo(results[0]);
      }
    });
  });

  // ğŸ“Œ `localStorage`ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° ë¡œë“œ ì‹œ)
  let savedLocation = localStorage.getItem("selectedLocation");
  if (savedLocation) {
    savedLocation = JSON.parse(savedLocation);

    document.getElementById('province').value = savedLocation.province || "";
    document.getElementById('city').value = savedLocation.city || "";
    document.getElementById('district').value = savedLocation.district || "";
    document.getElementById('road-address').value = savedLocation.roadAddress || "";
    document.getElementById('apartment').value = savedLocation.apartment || "";
    document.getElementById('building-name').value = savedLocation.buildingName || "";
    document.getElementById('postal-code').value = savedLocation.postalCode || "";

    if (savedLocation.latitude && savedLocation.longitude) {
      marker.setPosition({ lat: savedLocation.latitude, lng: savedLocation.longitude });
      map.setCenter({ lat: savedLocation.latitude, lng: savedLocation.longitude });
    }
  }
}

function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
      map.setCenter(latLng);
      marker.setPosition(latLng);
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: latLng }, function (results, status) {
        if (status === google.maps.GeocoderStatus.OK) {
          displayAddressInfo(results[0]);
        }
      });
    }, function () {
      alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    });
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
}

function displayAddressInfo(place) {
  document.getElementById('address-info').style.display = 'block';

  const addressComponents = place.address_components;
  let addressData = {
    province: "",
    city: "",
    district: "",
    roadAddress: "",
    apartment: "",
    buildingName: "",
    postalCode: "",
    latitude: place.geometry.location.lat(),
    longitude: place.geometry.location.lng()
  };

  addressComponents.forEach(component => {
    const types = component.types;
    if (types.includes("administrative_area_level_1")) {
      addressData.province = component.long_name;
    }
    if (types.includes("locality")) {
      addressData.city = component.long_name;
    }
    if (types.includes("sublocality_level_1")) {
      addressData.district = component.long_name;
    }
    if (types.includes("route")) {
      addressData.roadAddress = component.long_name;
    }
    if (types.includes("premise")) {
      addressData.apartment = component.long_name;
    }
    if (types.includes("building")) {
      addressData.buildingName = component.long_name;
    }
    if (types.includes("postal_code")) {
      addressData.postalCode = component.long_name;
    }
  });

  // ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
  document.getElementById('province').value = addressData.province;
  document.getElementById('city').value = addressData.city;
  document.getElementById('district').value = addressData.district;
  document.getElementById('road-address').value = addressData.roadAddress;
  document.getElementById('apartment').value = addressData.apartment;
  document.getElementById('building-name').value = addressData.buildingName;
  document.getElementById('postal-code').value = addressData.postalCode;

  // ğŸ“Œ `localStorage`ì— ì €ì¥
  localStorage.setItem("selectedLocation", JSON.stringify(addressData));
}

// "ë‹¤ìŒ" ë²„íŠ¼ í´ë¦­ ì‹œ ì €ì¥ & ìœ íš¨ì„± ê²€ì‚¬
document.querySelector('.next-btn').addEventListener('click', function (event) {
    let selectedLocation = {
        province: document.getElementById('province').value,
        city: document.getElementById('city').value,
        district: document.getElementById('district').value,
        roadAddress: document.getElementById('road-address').value,
        apartment: document.getElementById('apartment').value,
        buildingName: document.getElementById('building-name').value,
        postalCode: document.getElementById('postal-code').value,
        latitude: marker.getPosition().lat(),
        longitude: marker.getPosition().lng()
    };

    // ğŸ“Œ `address`ë¥¼ ì¡°í•©í•˜ì—¬ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ë§Œë“¤ê¸°
    let addressParts = [
        selectedLocation.province,
        selectedLocation.city,
        selectedLocation.district,
        selectedLocation.roadAddress,
        selectedLocation.apartment,
        selectedLocation.buildingName,
        selectedLocation.postalCode ? `ìš°í¸ë²ˆí˜¸: ${selectedLocation.postalCode}` : ""
    ].filter(Boolean).join(", "); // ë¹ˆ ê°’ ì œì™¸í•˜ê³  ì½¤ë§ˆ(,)ë¡œ ì—°ê²°

    //  `localStorage`ì— ìµœì¢… ì €ì¥
    localStorage.setItem("selectedLocation", JSON.stringify(selectedLocation));
    localStorage.setItem("address", addressParts); // ìµœì¢… ì£¼ì†Œ ì €ì¥
    localStorage.setItem("latitude", selectedLocation.latitude);
    localStorage.setItem("longitude", selectedLocation.longitude);

    console.log(" ì €ì¥ëœ ì£¼ì†Œ:", addressParts);
    console.log(" ì €ì¥ëœ ìœ„ë„:", selectedLocation.latitude);
    console.log(" ì €ì¥ëœ ê²½ë„:", selectedLocation.longitude);

    if (!selectedLocation.roadAddress) {
        event.preventDefault();
        alert('ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
    } else {
        window.location.href = '/host/floor-plan'; // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
    }
});
</script>
</body>
</html>