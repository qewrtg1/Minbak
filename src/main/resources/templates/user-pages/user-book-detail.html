<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜ˆì•½í•œ ìˆ™ì†Œ ìƒì„¸ë³´ê¸°</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- âœ… ì¹´ì¹´ì˜¤ ì§€ë„ API -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b885630c0823c3db8c4b7d8da74981dd&libraries=services"></script>
  <style>
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ì„¤ì • */
    .main-container {
        display: flex;
        height: 100vh;
    }

    /* ì™¼ìª½ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ˆì•½ ìƒì„¸ ì •ë³´ */
    .details-container {
        width: 50%;
        overflow-y: auto;
        padding: 20px;
    }

    /* ì˜¤ë¥¸ìª½ ê³ ì •ëœ ì§€ë„ */
    .map-container {
        width: 50%;
        position: sticky;
        top: 0;
        height: 100vh;
    }

    /* ìˆ™ì†Œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .room-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* í˜¸ìŠ¤íŠ¸ ì •ë³´ */
    .host-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .host-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
  </style>
</head>
<body>
<div th:replace="~{user-pages/common/header}"></div>
<div class="main-container">
  <!-- ì™¼ìª½: ì˜ˆì•½ ìƒì„¸ ì •ë³´ -->
  <div class="details-container">
    <a th:href="@{/user/book/list}" class="text-decoration-none">&larr; ì˜ˆì•½ëª©ë¡ìœ¼ë¡œê°€ê¸°</a>

    <h2 class="mt-3" th:text="${book.room.name}">ìˆ™ì†Œ ì´ë¦„</h2>

    <div class="host-info mt-2">
            <img th:src="${book.userUrl}" alt="í˜¸ìŠ¤íŠ¸ ì´ë¯¸ì§€" class="host-img">
      <div>
        <p class="mb-0 fw-bold" th:text="${book.user.name}">í˜¸ìŠ¤íŠ¸ ì´ë¦„</p>
<!--        <p class="text-muted small">í˜¸ìŠ¤íŠ¸ ì†Œê°œ : <span th:text="${host.introduction}">3</span></p>-->
        <p class="text-muted small">
          í˜¸ìŠ¤íŒ… ê²½ë ¥
          <span th:if="${yearsOfExperience > 0}" th:text="${yearsOfExperience} + 'ë…„'">3ë…„</span>
          <span th:if="${yearsOfExperience == 0}">1ë…„ ë¯¸ë§Œ</span>
        </p>
      </div>
    </div>

    <!-- ìˆ™ì†Œ ì´ë¯¸ì§€ -->
    <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner">
        <!-- Thymeleafë¥¼ ì´ìš©í•˜ì—¬ ë°˜ë³µë¬¸ìœ¼ë¡œ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œë¥¼ ì¶”ê°€ -->
        <div th:each="roomUrl, iterStat : ${book.roomUrls}"
             class="carousel-item"
             th:classappend="${iterStat.index == 0} ? 'active' : ''">
          <img th:src="@{${roomUrl}}" alt="ìˆ™ì†Œ ì´ë¯¸ì§€" class="d-block w-100 room-image">
        </div>
      </div>

      <!-- ì´ì „, ë‹¤ìŒ ë²„íŠ¼ -->
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <style>
      /* Carousel ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
      .carousel-inner {
        max-height: 500px; /* ìµœëŒ€ ë†’ì´ ì„¤ì • (í•„ìš”ì— ë§ê²Œ ì¡°ì •) */
        overflow: hidden;  /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ë„ë¡ ì„¤ì • */
      }

      .carousel-item img {
        object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ê³µê°„ì„ ê°€ë“ ì±„ì›€ */
        width: 100%; /* ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ê²Œ í™•ì¥ */
        height: 100%; /* ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ê²Œ í™•ì¥ */
      }

      /* ìŠ¬ë¼ì´ë“œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ë””ìì¸ */
      .carousel-control-prev-icon,
      .carousel-control-next-icon {
        background-color: black; /* ë²„íŠ¼ ìƒ‰ìƒ */
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .carousel-inner {
          max-height: 300px; /* ëª¨ë°”ì¼ì—ì„œ ìµœëŒ€ ë†’ì´ ì¤„ì´ê¸° */
        }
      }
    </style>


    <!-- ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ ì •ë³´ -->
    <div class="mt-4 p-3 border rounded">
      <h5>ì²´í¬ì¸ / ì²´í¬ì•„ì›ƒ</h5>
      <p>ì²´í¬ì¸: <strong th:text="${#temporals.format(book.startDate, 'yyyyë…„ Mì›” dì¼')}">9ì›” 30ì¼ (ê¸ˆ)</strong> (ì²´í¬ì¸ì‹œê°„ì—†ìŒ)ì˜¤í›„ 3:00</p>
      <p>ì²´í¬ì•„ì›ƒ: <strong th:text="${#temporals.format(book.endDate, 'yyyyë…„ Mì›” dì¼')}">10ì›” 1ì¼ (í† )</strong> (ì²´í¬ì•„ì›ƒì‹œê°„ì—†ìŒ)ì˜¤ì „ 11:00</p>
    </div>

    <!-- ì˜ˆì•½ ìƒíƒœ -->
    <div class="mt-3 p-3 border rounded">
      <h5>ì˜ˆì•½ ìƒíƒœ</h5>
      <p th:text="${book.status}">í™•ì •ë¨</p>
      <div th:if="${book.status =='ìˆ˜ë½'}">
        <a th:href="@{/user/book/pay/{bookId}(bookId=${book.bookId})}">ê²°ì œí•˜ê¸°</a>
      </div>

    </div>

    <!-- ìš”ê¸ˆ ì •ë³´ -->
    <div class="mt-3 p-3 border rounded">
      <h5>ìš”ê¸ˆ ìƒì„¸</h5>
      <p>ìˆ™ë°• ìš”ê¸ˆ: â‚©
        <span th:text="${book.room.price}">200,000</span> X <span class="daysDiff">00</span>ë°•</p>
<!--      <p>ì²­ì†Œë¹„: â‚©<span th:text="${book.cleaningFee}">30,000</span></p>-->
<!--      <p>ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œ: â‚©<span th:text="${book.serviceFee}">10,000</span></p>-->
      <hr>
      <h5>ì´ì•¡: â‚©<span class="totalPrice">000,000</span></h5>
    </div>

<!--    &lt;!&ndash; ê²°ì œ ìƒíƒœ  ê²°ì œ ë°ì´í„° ë¶ˆëŸ¬ì™€ì•¼í•¨&ndash;&gt;-->
<!--    <div class="mt-3 p-3 border rounded">-->
<!--      <h5>ê²°ì œ ìƒíƒœ</h5>-->
<!--      <p>ê²°ì œ : <span th:text="${book.status}">í™•ì •ë¨</span></p>-->
<!--    </div>-->

    <div class="container mt-4">
      <div class="p-3 border rounded d-flex align-items-center">
        <i class="bi bi-chat-dots me-2"></i>
        <div style="width:100%;">
          <p class="mb-0 fw-bold">í˜¸ìŠ¤íŠ¸ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</p>
          <p class="text-muted small" th:text="${book.user.name}">í‚¤ë‹¤ë¦¬ì—¬ìš°</p>
          <div class="chat-input">
            <form id="messageForm">
              <input type="text" class="form-control messageContent" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="height: 100px; width: 100%; font-size: 16px;" />
              <input type="number" style="display:none" class="form-control" id="receiverId" th:value="${book.user.userId}" />
              <button class="btn btn-primary">ë³´ë‚´ê¸°</button>
            </form>
          </div>
        </div>
      </div>
    </div>

<!--    <div class="container mt-3">-->
<!--      <div class="p-3 border rounded d-flex align-items-center">-->
<!--        <i class="bi bi-house-door me-2"></i>-->
<!--        <div>-->
<!--          <p class="mb-0 fw-bold">ìˆ™ì†Œ</p>-->
<!--          <p class="text-muted small" th:text="${book.room.name}">S1ë…ì‹¤</p>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
    <div class="container mt-3 p-3 border rounded">
      <h5 class="fw-bold">ì˜ˆì•½ ì„¸ë¶€ì •ë³´</h5>

      <p class="mb-1">ğŸ§‘â€ğŸ¤â€ğŸ§‘ <strong>ê²ŒìŠ¤íŠ¸:</strong> <span th:text="${book.guestsNum}">2</span>ëª…</p>

      <p class="mb-1">ğŸ”¢ <strong>ì˜ˆì•½ ë²ˆí˜¸:</strong> <span th:text="${book.bookId}">HMK92MCJK</span></p>
    </div>
    <div class="container mt-3 p-3 border rounded">
      <h5 class="fw-bold">í™˜ë¶ˆ ì •ì±…</h5>
      <p>
        ì²´í¬ì¸ ì‹œê°„ì¸ <strong th:text="${#temporals.format(book.startDate, 'Mì›” dì¼')}">9ì›” 30ì¼ ì˜¤í›„ 12:00</strong> ì „ê¹Œì§€ ì·¨ì†Œí•˜ë©´
        ë¶€ë¶„ í™˜ë¶ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ ì´í›„ì— ì·¨ì†Œí•˜ë©´ ì˜ˆì•½ ëŒ€ê¸ˆì´ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </p>
      <a href="#" class="text-decoration-none">ìì„¸íˆ ì•Œì•„ë³´ê¸°</a>
    </div>
    <div class="container mt-3">
      <button class="btn btn-outline-secondary w-100 mb-2">ğŸ“„ ì—¬í–‰ ì¼ì •í‘œ PDFë¡œ ë°›ê¸° (ë¹„ì ì‹ ì²­ìš©)</button>
      <button class="btn btn-outline-secondary w-100 mb-2">ğŸ” ì„¸ë¶€ì •ë³´ ì¸ì‡„í•˜ê¸°</button>
      <button class="btn btn-outline-secondary w-100">ğŸ’° ì˜ìˆ˜ì¦ ë°›ê¸°</button>
    </div>
    <div class="container mt-4 p-3 border rounded">
      <h5 class="fw-bold">ìˆ™ì†Œ ì´ìš©ê·œì¹™ ë° ì•ˆë‚´</h5>

      <!-- ìˆ™ì†Œ í˜•íƒœ -->
      <div class="mt-3">
        <h6 class="fw-bold">ìˆ™ì†Œ í˜•íƒœ</h6>
        <p >ìˆ™ì†Œ íƒ€ì…: <span th:text="${book.room.buildingType}"></span></p>
        <p >ì¹¨ì‹¤: <span th:text="${book.room.bedrooms}"></span></p>
        <p >ì¹¨ëŒ€: <span th:text="${book.room.beds}"></span></p>
        <p >í™”ì¥ì‹¤: <span th:text="${book.room.bathrooms}"></span></p>
        <a href="#" class="text-decoration-none">ë” ë³´ê¸°</a>
      </div>

      <hr>

      <!-- ìˆ™ì†Œ ì´ìš©ê·œì¹™ -->
      <div class="mt-3">
        <h6 class="fw-bold">ìˆ™ì†Œ íŠ¹ì´ì‚¬í•­(ìœ ì €ê°€ì´ë“œ)</h6>
        <p th:text="${book.room.useGuide}">
          ì…€í”„ ì²´í¬ì¸: í‚¤íŒ¨ë“œ<br>
          ê²ŒìŠ¤íŠ¸ ì •ì›: 3ëª…<br>
          ë°˜ë ¤ë™ë¬¼ ë™ë°˜ ë¶ˆê°€
        </p>
        <a href="#" class="text-decoration-none">ë” ë³´ê¸°</a>
      </div>

      <hr>

      <!-- ìˆ™ì†Œ ë³´ê¸° ë²„íŠ¼ -->
      <button class="btn btn-outline-secondary w-100">ğŸ  ìˆ™ì†Œ ë³´ê¸°</button>
    </div>
    <div class="container mt-4 p-3 border rounded">
      <h5 class="fw-bold">í˜¸ìŠ¤íŠ¸: <span th:text="${book.user.name}">í‚¤ë‹¤ë¦¬ì—¬ìš°ë‹˜</span></h5>

      <!-- í˜¸ìŠ¤íŠ¸ ì†Œê°œ  í˜¸ìŠ¤íŠ¸ idë‘ ì—°ê²°í•´ì•¼í•¨-->
      <div class="mt-3">
        <h6 class="fw-bold">í˜¸ìŠ¤íŠ¸ ì†Œê°œ</h6>
                <p th:text="${host.introduction}">
        ê²½ì£¼ìŠ¤ëŸ¬ìš´ ë¶„ìœ„ê¸°ë¡œ ê²ŒìŠ¤íŠ¸ë‹˜ì˜ ì—¬í–‰ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
        </p>
        <a href="#" class="text-decoration-none">ë” ë³´ê¸°</a>
      </div>

      <hr>

      <!-- ê³µë™ í˜¸ìŠ¤íŠ¸ ì •ë³´ êµ¬í˜„ xí•˜ì§€ì•Šì„ê¹Œ -->
<!--      <div class="mt-3">-->
<!--        <h6 class="fw-bold">ê³µë™ í˜¸ìŠ¤íŠ¸</h6>-->
<!--        &lt;!&ndash;        <p th:text="${booking.host.cohosts}">ê¸°ë³¸ì¢‹ì€ ì‚¬ëŒ</p>&ndash;&gt;-->
<!--      </div>-->
<!--      <hr>-->

      <!-- í˜¸ìŠ¤íŠ¸ ê°€ì´ë“œë¶ ë²„íŠ¼ -->
      <button class="btn btn-outline-secondary w-100">ğŸ“– í˜¸ìŠ¤íŠ¸ ê°€ì´ë“œë¶</button>
    </div>
    <div class="container mt-4 p-3 border rounded">
      <h5 class="fw-bold">ê²°ì œ ì •ë³´</h5>
      <!--ê²°ì œ ê¸ˆì•¡ ê²°ì œë‘ ì—°ê²°í•´ì•¼í•¨-->
<!--            <p class="mt-2">ğŸ’° <strong>ê²°ì œí•œ ê¸ˆì•¡:</strong> â‚©<span id="totalPrice"></span></p>-->

      <hr>

      <!-- ì˜ìˆ˜ì¦ ë°›ê¸° ë²„íŠ¼ -->
      <button class="btn btn-outline-secondary w-100">ğŸ§¾ ì˜ìˆ˜ì¦ ë°›ê¸°</button>
    </div>
    <div class="container mt-4 p-3 border rounded">
      <h5 class="fw-bold">ì–¸ì œë“  ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”</h5>
      <p class="text-muted small">
        ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ì „ ì„¸ê³„ ì–´ë””ì„œë“  ì—°ì¤‘ë¬´íœ´ë¡œ ì§€ì›í•´ë“œë¦½ë‹ˆë‹¤.
      </p>

      <hr>

      <!-- ê³ ê° ì§€ì› ë§í¬ -->
      <a href="#" class="d-block text-decoration-none py-2">ğŸ“ ì—ì–´ë¹„ì•¤ë¹„ ê³ ê°ì§€ì› íŒ€ì— ì—°ë½í•˜ê¸°</a>
      <a href="#" class="d-block text-decoration-none py-2">ğŸ“š ë„ì›€ë§ ì„¼í„° ë°©ë¬¸í•˜ê¸°</a>
    </div>

  </div>

  <!-- ì˜¤ë¥¸ìª½: ì§€ë„ -->
  <div class="map-container">
    <div id="map" style="width: 100%; height: 100%;"></div>
  </div>
</div>

<!-- ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ API -->
<!--<script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>-->
<script>
  var map, geocoder, marker;

  function initMap() {
      console.log("ğŸš€ ì§€ë„ ë¡œë”© ì¤‘...");
      var defaultLocation = new kakao.maps.LatLng([[${book.room.latitude}]], [[${book.room.longitude}]]); // ì´ˆê¸° ìœ„ì¹˜ (ì„œìš¸ ì‹œì²­)

      map = new kakao.maps.Map(document.getElementById('map'), {
          center: defaultLocation,
          level: 3 // ì§€ë„ í™•ëŒ€ ë ˆë²¨
      });

      geocoder = new kakao.maps.services.Geocoder();
      marker = new kakao.maps.Marker({ position: defaultLocation, map: map });

      console.log("âœ… ì§€ë„ ë¡œë”© ì™„ë£Œ!");
  }

  function openAddressSearch() {
      console.log("ğŸ“ ì£¼ì†Œ ê²€ìƒ‰ ì‹¤í–‰");
      new daum.Postcode({
          oncomplete: function(data) {
              var fullAddress = data.roadAddress || data.jibunAddress;
              document.getElementById("address").value = fullAddress;

              // âœ… ì£¼ì†Œ â†’ ìœ„ë„/ê²½ë„ ë³€í™˜
              geocoder.addressSearch(fullAddress, function(result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                      var latlng = new kakao.maps.LatLng(result[0].y, result[0].x);
                      document.getElementById("latitude").value = result[0].y;
                      document.getElementById("longitude").value = result[0].x;

                      // âœ… ì§€ë„ ì´ë™ ë° ë§ˆì»¤ í‘œì‹œ
                      map.setCenter(latlng);
                      marker.setPosition(latlng);

                      console.log("ğŸ—º ì§€ë„ ìœ„ì¹˜ ì—…ë°ì´íŠ¸: " + fullAddress);
                  } else {
                      alert("âš  ìœ„ë„/ê²½ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                  }
              });
          }
      }).open();
  }



</script>

<script>
  //ë‚ ì§œ ê³„ì‚° ìŠ¤í¬ë¦½íŠ¸

  // Thymeleafì—ì„œ ì „ë‹¬ëœ ë¬¸ìì—´ì„ JavaScript Date ê°ì²´ë¡œ ë³€í™˜
  function calculateDays(){
let startDate = new Date("[[${book.startDate}]]");
let endDate = new Date("[[${book.endDate}]]");
let pricePerDay = [[${book.room.price}]];

// ë‘ ë‚ ì§œì˜ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
let timeDiff = endDate - startDate;

// ë°€ë¦¬ì´ˆë¥¼ ì¼(day) ë‹¨ìœ„ë¡œ ë³€í™˜
let daysDiff = Math.abs(timeDiff / (1000 * 3600 * 24));

// ì´ì•¡ ê³„ì‚°
let totalPrice = daysDiff * pricePerDay;



  console.log("ë‚ ì§œ ì°¨ì´: " + daysDiff + "ì¼");
  console.log("ì´ì•¡: " + totalPrice + "ì›");
   document.querySelector(".daysDiff").textContent = daysDiff ;
   document.querySelector(".totalPrice").textContent = totalPrice.toLocaleString() ;
}
 window.onload = function() {calculateDays(); initMap();}

 //ë©”ì„¸ì§€ ê´€ë ¨

  document.getElementById('messageForm').addEventListener('submit', function(event) {
      event.preventDefault(); // í˜ì´ì§€ ë¦¬ë¡œë”©ì„ ë°©ì§€

      let content = document.querySelector('.messageContent').value;
      let receiverId = document.getElementById('receiverId').value;

    // ë©”ì‹œì§€ ì „ì†¡
fetch('/user/messageList/create', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    content: content,    // ë©”ì‹œì§€ ë‚´ìš©
    receiverId: receiverId
  })
})
  .then(response => {
    // ì‘ë‹µ ìƒíƒœ ì½”ë“œ í™•ì¸
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();  // ì„±ê³µì ì¸ ì‘ë‹µì´ë¼ë©´ JSON íŒŒì‹±
  })
  .then(data => {
    // ì„±ê³µì ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ì „ì†¡ëœ ê²½ìš°
    if (data.success) {
      alert("ë©”ì„¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
       document.querySelector('.messageContent').value = '';
    } else {
      // ì„œë²„ì—ì„œ successê°€ falseì¸ ê²½ìš°
      alert("ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  })
  .catch(error => {
    // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë‚˜ ê¸°íƒ€ ì˜¤ë¥˜ ì²˜ë¦¬
    console.error('Error:', error);
    alert("ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  })});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<div th:replace="~{user-pages/common/footer}"></div>
</body>
</html>