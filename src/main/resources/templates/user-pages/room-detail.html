<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìœ ì € ì •ë³´</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://kit.fontawesome.com/18733371c0.js" crossorigin="anonymous"></script>



  <style>
    .title{
      width: 1300px;
      margin: 0 auto;
      margin-top: 30px;
      display: flex;
    }
    .gallery-container {
        width: 1300px;
        height: 560px;
        margin: 0 auto;
        /* border: 1px solid #000; */
        display: flex;
        padding: 0 !important;
    }
    .thumbnail-container {
      width: 700px;
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2ì—´ */
      grid-template-rows: auto auto;         /* 2í–‰ (ìë™ ë†’ì´) */
      gap: 8px;                              /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
      margin-left: 10px;
    }

    .subImg {
      flex: 0 0 auto;
      width: 23%;
      height: 23%;
    }

    .mainImg {
      width: 700px;
      height: 560px;
      border-radius: 8px;
      overflow: hidden;
    }

    .mainImg img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      /* border: 1px solid #000; */
    }

    .subImg {
      width: 340px;
      height: 275px;
      border-radius: 8px;
      overflow: hidden;
      padding: 0 !important;
    }


    .likeBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.8); /* ì•½ê°„ íˆ¬ëª…í•œ í° ë°°ê²½ */
        padding: 5px 10px;
        border-radius: 5px;
        z-index: 10;
        font-weight: bold;
        font-size: 14px;
    }

    .thumbnail-container img {
        width: 341px;
        height: 278px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: opacity 0.3s;
        margin-top: 1px;
    }

    .thumbnail-container img:hover {
        opacity: 0.7;
    }


    .map-container {
        width: 100%;
        height: 400px;
        border-radius: 8px;
    }

    .flatpickr-input {
      background-color: #fff;
      cursor: pointer;
      border-radius: 5px;
    }
    .input-group .form-control {
  border-radius: 8px !important; /* ì›í•˜ëŠ” ë‘¥ê·¼ ì •ë„ë¡œ */
}

  </style>

</head>
<body>

<!--í—¤ë”-->
<div th:replace="~{user-pages/common/header}"></div>

<div class="title">
  <h2 style="width: 80%;" th:text="${room.name}"> fffffffffffffffffff</h2>
  <div style="padding: 10px 10px; width: 200px; text-align: right;" ><i class="fa-solid fa-arrow-up-from-bracket"></i>&nbspê³µìœ í•˜ê¸°</div>
  <div style="padding: 10px 10px; width: 100px; text-align: right;"><i class="fa-regular fa-heart"></i>&nbspì €ì¥</div>
</div>



<div class="container gallery-container">
  <!--todo ì°œí•˜ê¸° ë²„íŠ¼-->
  <div class="mainImg">
    <img id="mainImage" th:src="${room.imageUrls[0]}" alt="ìˆ™ì†Œ ì´ë¯¸ì§€">
  </div>


  <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ (ìµœëŒ€ 5ê°œë§Œ) -->
  <div class="row thumbnail-container">
    <div class="subImg" th:each="image, iterStat : ${room.imageUrls}" th:if="${iterStat.index < 4}">
      <img th:src="${image}" alt="ìˆ™ì†Œ ì´ë¯¸ì§€" class="thumbnail" onclick="changeImage(this)">
    </div>

  </div>
</div>


<div class="container mt-4">
  <div class="row">
    <!-- ì™¼ìª½: ìˆ™ì†Œ ì •ë³´ -->
    <div class="col-md-7">
      <h3 th:text="${room.title}">ìˆ™ì†Œ ì œëª©</h3>
      <p class="text-muted">
        ìµœëŒ€ ì¸ì› <span th:text="${room.maxGuests}">4</span>ëª… Â·
        ì¹¨ì‹¤ <span th:text="${room.bedrooms}">1</span>ê°œ Â·
        ì¹¨ëŒ€ <span th:text="${room.beds}">2</span>ê°œ Â·
        ìš•ì‹¤ <span th:text="${room.bathrooms}">1</span>ê°œ
      </p>
      <p>
        â­ <span th:text="${room.rating}">4.55</span> Â·
        <a href="#">í›„ê¸° <span th:text="${room.reviewCount}">58</span>ê°œ</a>
      </p>

      <!-- í¸ì˜ì‹œì„¤ ë¦¬ìŠ¤íŠ¸ -->
      <div class="row">
        <div class="col-6" th:each="facility : ${room.options}">
          <span>âœ”ï¸</span> <span th:text="${facility}">ì„¸íƒê¸°</span>
        </div>
      </div>

      <hr>

      <!-- í˜¸ìŠ¤íŠ¸ ì •ë³´ -->
      <div class="d-flex align-items-center">
        <!-- í˜¸ìŠ¤íŠ¸ ì´ë¯¸ì§€ (nullì´ ì•„ë‹ ë•Œë§Œ ë Œë”ë§) -->
        <img th:if="${host.imageUrl != null}" th:src="${host.imageUrl}" class="rounded-circle me-3" width="50" height="50" alt="í˜¸ìŠ¤íŠ¸ ì´ë¯¸ì§€">

        <div>
          <h5 class="mb-0" th:text="${host.name}">í˜¸ìŠ¤íŠ¸ ì´ë¦„</h5>
          <p class="text-muted">
            í˜¸ìŠ¤íŒ… ê²½ë ¥
            <span th:if="${host.yearsOfExperience > 0}" th:text="${host.yearsOfExperience} + 'ë…„'">3ë…„</span>
            <span th:if="${host.yearsOfExperience == 0}">1ë…„ ë¯¸ë§Œ</span>
          </p>

        </div>
      </div>


      <div class="mt-3 p-3 bg-light rounded">
        <p th:text="${room.content}">
          ìˆ™ì†Œ ì„¤ëª…ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì˜ˆì•½ ë°•ìŠ¤ -->
    <div class="col-md-5">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <span class="fw-bold fs-5 text-danger" th:text="'â‚©' + ${room.pricePerNight} + ' /ë°•'">â‚©60,000</span>
        </div>

        <!-- ì˜ˆì•½ í¼ -->
        <form class="mt-3" th:action="@{/user/room/{roomId}/confirm(roomId=${room.roomId})}" method="GET">
          <!-- ì²´í¬ì¸ & ì²´í¬ì•„ì›ƒ ì…ë ¥ í•„ë“œ -->
          <div class="input-group">
            <label class="form-label mt-2">ì²´í¬ì¸ &nbsp&nbsp&nbsp&nbsp</label>
            <input type="text" class="form-control flatpickr-input" id="checkInDate" name="checkInDate" placeholder="ë‚ ì§œ ì„ íƒ" required>
          </div>

          <div class="input-group mt-2">
            <label class="form-label mt-2" >ì²´í¬ì•„ì›ƒ&nbsp&nbsp</label>
            <input type="text" class="form-control flatpickr-input" id="checkOutDate" name="checkOutDate" placeholder="ë‚ ì§œ ì„ íƒ" required>
          </div>

          <!-- ì¸ì› ì„ íƒ -->
          <label class="form-label mt-2">ì¸ì›</label>
          <select class="form-select" name="guestsNum" required>
            <option th:each="num : ${#numbers.sequence(1, room.maxGuests)}"
                    th:value="${num}" th:text="|ê²ŒìŠ¤íŠ¸ ${num}ëª…|"></option>
          </select>

          <!-- âœ… ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ -->
          <button type="submit" class="btn btn-danger w-100 mt-3">ì˜ˆì•½í•˜ê¸°</button>
        </form>


        <p class="text-muted mt-2">ì˜ˆì•½ í™•ì • ì „ì—ëŠ” ìš”ê¸ˆì´ ì²­êµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

        <hr>

        <!-- ìš”ê¸ˆ ìƒì„¸ (ìˆ™ë°• ì¼ìˆ˜ ë™ì  ê³„ì‚°) -->
        <div class="d-flex justify-content-between">
          <span id="priceDetails" th:text="'â‚©' + ${room.pricePerNight} + 'X 1ë°•'">â‚©60,000 x 1ë°•</span>
          <span id="totalPrice" th:text="'â‚©' + ${room.pricePerNight}">â‚©60,000</span>
        </div>

        <hr>

        <div class="d-flex justify-content-between fw-bold">
          <span>ì´ì•¡</span>
          <span id="finalTotal" th:text="'â‚©' + ${room.pricePerNight}">â‚©60,000</span>
        </div>
      </div>


      <!-- ìš”ê¸ˆ ì•ˆë‚´ -->
      <!--      <div class="alert alert-light mt-3">-->
      <!--        <span>ğŸ’°</span> ìš”ê¸ˆ ì¸í•˜<br>-->
      <!--        ì§€ë‚œ 60ì¼ê°„ í‰ê·  ìš”ê¸ˆë³´ë‹¤ <span class="fw-bold text-danger" th:text="'â‚©' + ${room.discountAmount}">â‚©38,338</span> ì €ë ´í•©ë‹ˆë‹¤.-->
      <!--      </div>-->

      <!-- ì‹ ê³  ë²„íŠ¼ urlì—°ê²°-->
      <button class="btn btn-outline-secondary w-100 mt-2">ğŸ  ìˆ™ì†Œ ì‹ ê³ í•˜ê¸°</button>
    </div>
  </div>

</div>


<div class="container mt-5">
  <h4>ìœ„ì¹˜</h4>
  <p th:text="${room.address}">ì„œìš¸, í•œêµ­</p>

  <!-- ì§€ë„ í‘œì‹œ ì˜ì—­ -->
  <div id="map" class="map-container"></div>
</div>
<div class="container mt-5" th:if="${reviews != null and not #lists.isEmpty(reviews)}">
  <h4>â­ <span th:text="${room.rating}">4.55</span> Â· í›„ê¸° <span th:text="${room.reviewCount}">58</span>ê°œ</h4>

  <hr>

  <div class="row">
    <div class="col-md-6" th:each="review : ${reviews}">
      <div class="d-flex align-items-center mb-2">
        <img th:if="${review.user != null}" th:src="${review.user.profileImageUrl}" class="rounded-circle me-2" width="50" height="50" alt="ìœ ì € ì´ë¯¸ì§€">
        <div>
          <strong th:text="${review.user != null ? review.user.name : 'ìµëª… ì‚¬ìš©ì'}">ì‚¬ìš©ì ì´ë¦„</strong>
        </div>
      </div>

      <p>â­ <span th:text="${review.rating}">5.0</span></p>
      <p th:text="${review.content}">ë¦¬ë·° ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
      <p class="text-muted small"
         th:if="${review.date != null}"
         th:text="${#temporals.format(review.date, 'yyyyë…„ Mì›”')}">
      </p>
      <p class="text-muted small" th:if="${review.date == null}">ë‚ ì§œ ì •ë³´ ì—†ìŒ</p>

      <hr>
    </div>
  </div>

  <button class="btn btn-outline-secondary w-100 mt-3">í›„ê¸° <span th:text="${room.reviewCount}">58</span>ê°œ ëª¨ë‘ ë³´ê¸°</button>
</div>


<div class="container mt-5">
  <h4>ìˆ™ì†Œ í¸ì˜ì‹œì„¤</h4>

  <div th:each="categoryEntry : ${room.options}">
    <h5 th:text="${categoryEntry.key}">ì¹´í…Œê³ ë¦¬ ì´ë¦„</h5>
    <div class="row">
      <div class="col-md-6 mb-2" th:each="option : ${categoryEntry.value}">
        <span>âœ”ï¸</span> <span th:text="${option}">í¸ì˜ì‹œì„¤ í•­ëª©</span>
      </div>
    </div>
    <hr>
  </div>

  <button class="btn btn-outline-secondary mt-3">í¸ì˜ì‹œì„¤ ëª¨ë‘ ë³´ê¸°</button>
</div>

<div class="container mt-5">
  <h4>í˜¸ìŠ¤íŠ¸ ì†Œê°œ</h4>

  <div class="row">
    <!-- í˜¸ìŠ¤íŠ¸ í”„ë¡œí•„ ì¹´ë“œ -->
    <div class="col-md-6">
      <div class="card p-4 shadow-sm">
        <div class="d-flex flex-column align-items-center">
          <img th:src="${host.imageUrl}" class="rounded-circle mb-3" width="100" height="100" alt="í˜¸ìŠ¤íŠ¸ ì´ë¯¸ì§€">
          <h5 class="fw-bold mb-1" th:text="${host.name}">í˜¸ìŠ¤íŠ¸ ì´ë¦„</h5>
          <p class="text-muted">í˜¸ìŠ¤íŠ¸</p>
          <div class="text-center">
            <p>í›„ê¸° <strong th:text="${host.reviewCount}">1300</strong>ê°œ</p>
            <p>í‰ì  <strong th:text="${host.rating}">4.68</strong>â­</p>
            <p class="text-muted">
              í˜¸ìŠ¤íŒ… ê²½ë ¥
              <span th:if="${host.yearsOfExperience > 0}" th:text="${host.yearsOfExperience} + 'ë…„'">3ë…„</span>
              <span th:if="${host.yearsOfExperience == 0}">1ë…„ ë¯¸ë§Œ</span>
            </p>

          </div>
        </div>
      </div>
    </div>

    <h5 style="margin-top: 10px;">í˜¸ìŠ¤íŠ¸ ìƒì„¸ ì •ë³´</h5>
    <p>ì·¨ë¯¸: <strong th:text="${host.hobby}">100%</strong></p>
    <p>ì†Œê°œ: <strong th:text="${host.introduction}">100%</strong></p>
    <!--      <p>1ì‹œê°„ ì´ë‚´ ì‘ë‹µ</p>-->

    <button class="btn btn-dark w-100">í˜¸ìŠ¤íŠ¸ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>

    <p class="text-muted mt-3">
      ì•ˆì „í•œ ê²°ì œë¥¼ ìœ„í•´ í•­ìƒ ì—ì–´ë¹„ì•¤ë¹„ë¥¼ í†µí•´ ì†¡ê¸ˆí•˜ê³  í˜¸ìŠ¤íŠ¸ì™€ ì†Œí†µí•˜ì„¸ìš”.
    </p>
  </div>
</div>
<div th:replace="~{user-pages/common/footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>




<script>
  function changeImage(element) {
      document.getElementById("mainImage").src = element.src;
  }
</script>
<!-- Google Maps API ìŠ¤í¬ë¦½íŠ¸ -->
<script
        async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxxP5D76bjMkOWdY-LRMWuvRw6xhr1mr4&callback=initMap&loading=async&v=beta">
</script>
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
      // âœ… ì˜ˆì•½ëœ ë‚ ì§œ (ì˜ˆì œ ë°ì´í„°)
      let reservedRanges = [[${reservedDates}]];


      let disabledDates = new Set();

      // âœ… ì˜ˆì•½ëœ ë‚ ì§œë¥¼ Setìœ¼ë¡œ ì €ì¥ (ì¡°íšŒ ì†ë„ ìµœì í™”)
      reservedRanges.forEach(range => {
          let start = new Date(range.start_date);
          let end = new Date(range.end_date);

          while (start <= end) {
              disabledDates.add(start.toISOString().split("T")[0]); // YYYY-MM-DD í˜•ì‹
              start.setDate(start.getDate() + 1);
          }
      });

      console.log("ë¹„í™œì„±í™” ë‚ ì§œ: ", disabledDates); // ì½˜ì†”ì—ì„œ í™•ì¸

      // âœ… ì²´í¬ì¸ ë‚ ì§œ ì„ íƒ í•„ë“œ
      let checkInPicker = flatpickr("#checkInDate", {
          dateFormat: "Y-m-d",
          minDate: "today",
          disable: [...disabledDates], // ì˜ˆì•½ëœ ë‚ ì§œ ë¹„í™œì„±í™”
          onChange: function (selectedDates) {
              let checkOutPicker = document.getElementById("checkOutDate")._flatpickr;
              if (!selectedDates[0]) return;

              let minCheckOut = selectedDates[0].fp_incr(1);
              checkOutPicker.set("minDate", minCheckOut);
              checkOutPicker.setDate(""); // ì²´í¬ì•„ì›ƒ ì´ˆê¸°í™”
          }
      });

      // âœ… ì²´í¬ì•„ì›ƒ ë‚ ì§œ ì„ íƒ í•„ë“œ
      let checkOutPicker = flatpickr("#checkOutDate", {
          dateFormat: "Y-m-d",
          minDate: "today",
          disable: [...disabledDates],
          onChange: function (selectedDates) {
              if (!selectedDates[0]) return;
              let checkInDate = document.getElementById("checkInDate").value;

              if (!checkInDate) {
                  alert("âš  ì²´í¬ì¸ ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
                  checkOutPicker.clear();
                  return;
              }

              let startDate = new Date(checkInDate);
              let endDate = selectedDates[0];

              // âœ… ì²´í¬ì¸-ì²´í¬ì•„ì›ƒ ì‚¬ì´ì— ì˜ˆì•½ëœ ë‚ ì§œê°€ ìˆëŠ”ì§€ í™•ì¸
              let invalidDateFound = false;
              let tempDate = new Date(startDate);
              tempDate.setDate(tempDate.getDate() + 1); // ì²´í¬ì¸ ë‹¤ìŒë‚ ë¶€í„° ê²€ì‚¬

              while (tempDate <= endDate) {
                  if (disabledDates.has(tempDate.toISOString().split("T")[0])) {
                      invalidDateFound = true;
                      break;
                  }
                  tempDate.setDate(tempDate.getDate() + 1);
              }

              // âœ… ì˜ˆì•½ëœ ë‚ ì§œê°€ í¬í•¨ëœ ê²½ìš° ê²½ê³  ë° ì²´í¬ì¸ & ì²´í¬ì•„ì›ƒ ì´ˆê¸°í™”
              if (invalidDateFound) {
                  alert("âš  ì„ íƒí•œ ê¸°ê°„ì— ì˜ˆì•½ëœ ë‚ ì§œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                  checkInPicker.clear();
                  checkOutPicker.clear();
              }
          }
      });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkInInput = document.getElementById("checkInDate");
    const checkOutInput = document.getElementById("checkOutDate");
    const priceDetails = document.getElementById("priceDetails");
    const totalPrice = document.getElementById("totalPrice");
    const finalTotal = document.getElementById("finalTotal");

    const pricePerNight = parseInt([[${room.pricePerNight}]]); // Thymeleafì—ì„œ ê°€ê²© ê°€ì ¸ì˜¤ê¸°

    function updatePrice() {
      const checkInDate = new Date(checkInInput.value);
      const checkOutDate = new Date(checkOutInput.value);

      if (isNaN(checkInDate) || isNaN(checkOutDate) || checkOutDate <= checkInDate) {
        priceDetails.innerText = `â‚©${pricePerNight} x 1ë°•`;
        totalPrice.innerText = `â‚©${pricePerNight}`;
        finalTotal.innerText = `â‚©${pricePerNight}`;
        return;
      }

      // ìˆ™ë°• ì¼ìˆ˜ ê³„ì‚°
      const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

      // ê°€ê²© ê³„ì‚°
      const total = pricePerNight * nights;

      // í™”ë©´ ì—…ë°ì´íŠ¸
      priceDetails.innerText = `â‚©${pricePerNight} x ${nights}ë°•`;
      totalPrice.innerText = `â‚©${total}`;
      finalTotal.innerText = `â‚©${total}`;
    }

    checkInInput.addEventListener("change", updatePrice);
    checkOutInput.addEventListener("change", updatePrice);
  });
</script>

<script th:inline="javascript">
  async function initMap() {
      const mapElement = document.getElementById('map');
      if (!mapElement) {
          console.error("ì§€ë„ ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
      }

      // íƒ€ì„ë¦¬í”„ ë³€ìˆ˜ë¥¼ ìˆ«ìë¡œ ë³€í™˜
      var roomLatitude = parseFloat([[${room.latitude}]]);
      var roomLongitude = parseFloat([[${room.longitude}]]);

      if (isNaN(roomLatitude) || isNaN(roomLongitude)) {
          console.error("ì˜ëª»ëœ ì¢Œí‘œ ê°’ì…ë‹ˆë‹¤:", roomLatitude, roomLongitude);
          return;
      }

      var roomLocation = { lat: roomLatitude, lng: roomLongitude };

      // âœ… Google Maps API ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      var map = new google.maps.Map(mapElement, {
          zoom: 14,
          center: roomLocation,
          mapId: "DEMO_MAP_ID" // ê¸°ë³¸ ì§€ë„ ID ì„¤ì •
      });

      // âœ… ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ë§ˆì»¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      // âœ… ê³ ê¸‰ ë§ˆì»¤ ì¶”ê°€
      const marker = new AdvancedMarkerElement({
          position: roomLocation,
          map: map
      });

      console.log("Google Maps ì´ˆê¸°í™” ì™„ë£Œ");
  }
</script>

</body>
</html>
