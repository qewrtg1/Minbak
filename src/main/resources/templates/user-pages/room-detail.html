<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>유저 정보</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


  <style>
    /* 사용자 정보 영역 */
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .user-name {
        font-size: 16px;
        font-weight: 600;
    }
    .menu-button {
        background: none;
        border: none;
        cursor: pointer;
    }
    .menu-button img {
        width: 30px;
        height: 30px;
    }
    .navbar {
        padding: 10px 20px;
    }
  </style>

  <style>
    .gallery-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .main-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
    }
    .thumbnail-container img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: opacity 0.3s;
    }
    .thumbnail-container img:hover {
        opacity: 0.7;
    }
  </style>


  <style>
    .map-container {
        width: 100%;
        height: 400px;
        border-radius: 8px;
    }
  </style>
  <style>
    .flatpickr-input {
      background-color: #fff;
      cursor: pointer;
    }
  </style>

</head>
<body>


<!-- 네비게이션 바 -->
<nav class="navbar navbar-light bg-light d-flex justify-content-end">
  <div class="user-info">
    <!-- 로그인 여부 확인 -->
    <th:block th:if="${user != null}">
      <!-- 로그인한 경우 -->
      <img th:if="${userUrl != null}" th:src="${userUrl}" class="rounded-circle me-3" width="50" height="50" alt="유저 이미지">
      <input type="hidden" th:value="${user.userId}">
      <span class="user-name" th:text="${user.name}">사용자 이름</span>
      <button class="menu-button">메뉴</button>

      <!-- 로그아웃 버튼 -->
      <form id="logoutForm" action="/api/logout" method="post">
        <button type="submit" class="btn btn-danger ms-2">로그아웃</button>
      </form>
    </th:block>

    <th:block th:if="${user == null}">
      <!-- 로그인하지 않은 경우 -->

      <!-- 로그인 버튼 -->
      <div class="text-center mt-5">
        <button id="openLoginModal" class="btn btn-primary">로그인</button>
        <button id="logoutBtn" class="btn btn-danger d-none">로그아웃</button>
      </div>

      <!-- 로그인 모달 -->
      <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">로그인</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="email" class="form-label">이메일</label>
                  <input type="email" class="form-control" id="email" placeholder="이메일을 입력하세요">
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">비밀번호</label>
                  <input type="password" class="form-control" id="password" placeholder="비밀번호를 입력하세요">
                </div>
                <p id="loginError" class="text-danger text-center"></p>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary" id="loginBtn">로그인</button>
            </div>
          </div>
        </div>
      </div>

    </th:block>
  </div>
</nav>



<div class="container mt-4 gallery-container">
  <h2 th:text="${room.name}"></h2>

  <!--todo 찜하기 버튼-->
  <div>찜버튼 생성 예정</div>

  <!-- 첫 번째 이미지 (메인 이미지 대신) -->
  <div>
    <img id="mainImage" th:src="${room.imageUrls[0]}" alt="숙소 이미지" class="main-image">
  </div>

  <!-- 썸네일 이미지 리스트 (최대 5개만) -->
  <div class="row mt-2 thumbnail-container">
    <div class="col-3" th:each="image, iterStat : ${room.imageUrls}" th:if="${iterStat.index < 4}">
      <img th:src="${image}" alt="숙소 이미지" class="thumbnail" onclick="changeImage(this)">
    </div>
  </div>
</div>


<div class="container mt-4">
  <div class="row">
    <!-- 왼쪽: 숙소 정보 -->
    <div class="col-md-7">
      <h3 th:text="${room.title}">숙소 제목</h3>
      <p class="text-muted">
        최대 인원 <span th:text="${room.maxGuests}">4</span>명 ·
        침실 <span th:text="${room.bedrooms}">1</span>개 ·
        침대 <span th:text="${room.beds}">2</span>개 ·
        욕실 <span th:text="${room.bathrooms}">1</span>개
      </p>
      <p>
        ⭐ <span th:text="${room.rating}">4.55</span> ·
        <a href="#">후기 <span th:text="${room.reviewCount}">58</span>개</a>
      </p>

      <!-- 편의시설 리스트 -->
      <div class="row">
        <div class="col-6" th:each="facility : ${room.options}">
          <span>✔️</span> <span th:text="${facility}">세탁기</span>
        </div>
      </div>

      <hr>

      <!-- 호스트 정보 -->
      <div class="d-flex align-items-center">
        <!-- 호스트 이미지 (null이 아닐 때만 렌더링) -->
        <img th:if="${host.imageUrl != null}" th:src="${host.imageUrl}" class="rounded-circle me-3" width="50" height="50" alt="호스트 이미지">

        <div>
          <h5 class="mb-0" th:text="${host.name}">호스트 이름</h5>
          <p class="text-muted">
            호스팅 경력
            <span th:if="${host.yearsOfExperience > 0}" th:text="${host.yearsOfExperience} + '년'">3년</span>
            <span th:if="${host.yearsOfExperience == 0}">1년 미만</span>
          </p>

        </div>
      </div>


      <div class="mt-3 p-3 bg-light rounded">
        <p th:text="${room.content}">
          숙소 설명이 여기에 들어갑니다.
        </p>
      </div>
    </div>

    <!-- 오른쪽: 예약 박스 -->
    <div class="col-md-5">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <span class="fw-bold fs-5 text-danger" th:text="'₩' + ${room.pricePerNight}">₩60,000</span> /박
        </div>

        <!-- 예약 폼 -->
        <form class="mt-3">
          <!-- 체크인 & 체크아웃 입력 필드 -->
          <div class="input-group">
            <label class="form-label">체크인</label>
            <input type="text" class="form-control flatpickr-input" id="checkInDate" placeholder="날짜 선택">
          </div>

          <div class="input-group mt-2">
            <label class="form-label">체크아웃</label>
            <input type="text" class="form-control flatpickr-input" id="checkOutDate" placeholder="날짜 선택">
          </div>

          <label class="form-label mt-2">인원</label>
          <select class="form-select">
            <option th:each="num : ${#numbers.sequence(1, room.maxGuests)}"
                    th:value="${num}" th:text="|게스트 ${num}명|"></option>
          </select>

          <button type="submit" class="btn btn-danger w-100 mt-3">예약하기</button>
        </form>

        <p class="text-muted mt-2">예약 확정 전에는 요금이 청구되지 않습니다. (수수료 시스템 추가 예정)</p>

        <hr>

        <!-- 요금 상세 (숙박 일수 동적 계산) -->
        <div class="d-flex justify-content-between">
          <span id="priceDetails" th:text="'₩' + ${room.pricePerNight} + 'X 1박'">₩60,000 x 1박</span>
          <span id="totalPrice" th:text="'₩' + ${room.pricePerNight}">₩60,000</span>
        </div>

        <hr>

        <div class="d-flex justify-content-between fw-bold">
          <span>총액</span>
          <span id="finalTotal">₩60,000</span>
        </div>
      </div>


      <!-- 요금 안내 -->
<!--      <div class="alert alert-light mt-3">-->
<!--        <span>💰</span> 요금 인하<br>-->
<!--        지난 60일간 평균 요금보다 <span class="fw-bold text-danger" th:text="'₩' + ${room.discountAmount}">₩38,338</span> 저렴합니다.-->
<!--      </div>-->

      <!-- 신고 버튼 url연결-->
      <button class="btn btn-outline-secondary w-100 mt-2">🏠 숙소 신고하기</button>
    </div>
  </div>

</div>


<div class="container mt-5">
  <h4>위치</h4>
  <p th:text="${room.address}">서울, 한국</p>

  <!-- 지도 표시 영역 -->
  <div id="map" class="map-container"></div>
</div>
<div class="container mt-5" th:if="${reviews != null and not #lists.isEmpty(reviews)}">
  <h4>⭐ <span th:text="${room.rating}">4.55</span> · 후기 <span th:text="${room.reviewCount}">58</span>개</h4>

  <hr>

  <div class="row">
    <div class="col-md-6" th:each="review : ${reviews}">
      <div class="d-flex align-items-center mb-2">
        <img th:if="${review.user != null}" th:src="${review.user.profileImageUrl}" class="rounded-circle me-2" width="50" height="50" alt="유저 이미지">
        <div>
          <strong th:text="${review.user != null ? review.user.name : '익명 사용자'}">사용자 이름</strong>
        </div>
      </div>

      <p>⭐ <span th:text="${review.rating}">5.0</span></p>
      <p th:text="${review.content}">리뷰 내용이 여기에 들어갑니다.</p>
      <p class="text-muted small"
         th:if="${review.date != null}"
         th:text="${#temporals.format(review.date, 'yyyy년 M월')}">
      </p>
      <p class="text-muted small" th:if="${review.date == null}">날짜 정보 없음</p>

      <hr>
    </div>
  </div>

  <button class="btn btn-outline-secondary w-100 mt-3">후기 <span th:text="${room.reviewCount}">58</span>개 모두 보기</button>
</div>


<div class="container mt-5">
  <h4>숙소 편의시설</h4>

  <div th:each="categoryEntry : ${room.options}">
    <h5 th:text="${categoryEntry.key}">카테고리 이름</h5>
    <div class="row">
      <div class="col-md-4 mb-2" th:each="option : ${categoryEntry.value}">
        <span>✔️</span> <span th:text="${option}">편의시설 항목</span>
      </div>
    </div>
    <hr>
  </div>

  <button class="btn btn-outline-secondary mt-3">편의시설 모두 보기</button>
</div>

<div class="container mt-5">
  <h4>호스트 소개</h4>

  <div class="row">
    <!-- 호스트 프로필 카드 -->
    <div class="col-md-6">
      <div class="card p-4 shadow-sm">
        <div class="d-flex flex-column align-items-center">
          <img th:src="${host.imageUrl}" class="rounded-circle mb-3" width="100" height="100" alt="호스트 이미지">
          <h5 class="fw-bold mb-1" th:text="${host.name}">호스트 이름</h5>
          <p class="text-muted">호스트</p>
          <div class="text-center">
            <p>후기 <strong th:text="${host.reviewCount}">1300</strong>개</p>
            <p>평점 <strong th:text="${host.rating}">4.68</strong>⭐</p>
            <p class="text-muted">
              호스팅 경력
              <span th:if="${host.yearsOfExperience > 0}" th:text="${host.yearsOfExperience} + '년'">3년</span>
              <span th:if="${host.yearsOfExperience == 0}">1년 미만</span>
            </p>

          </div>
        </div>
      </div>
    </div>

      <h5>호스트 상세 정보</h5>
      <p>취미: <strong th:text="${host.hobby}">100%</strong></p>
      <p>소개: <strong th:text="${host.introduction}">100%</strong></p>
<!--      <p>1시간 이내 응답</p>-->

      <button class="btn btn-dark w-100">호스트에게 메시지 보내기</button>

      <p class="text-muted mt-3">
        안전한 결제를 위해 항상 에어비앤비를 통해 송금하고 호스트와 소통하세요.
      </p>
    </div>
  </div>
</div>


<!-- Bootstrap JS (Popper.js 포함) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>




<script>
  function changeImage(element) {
      document.getElementById("mainImage").src = element.src;
  }
</script>
<!-- Google Maps API 스크립트 -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxxP5D76bjMkOWdY-LRMWuvRw6xhr1mr4&callback=initMap">
</script>
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
      // ✅ 예약된 날짜 (예제 데이터)
      let reservedRanges = [[${reservedDates}]];


      let disabledDates = new Set();

      // ✅ 예약된 날짜를 Set으로 저장 (조회 속도 최적화)
      reservedRanges.forEach(range => {
          let start = new Date(range.start_date);
          let end = new Date(range.end_date);

          while (start <= end) {
              disabledDates.add(start.toISOString().split("T")[0]); // YYYY-MM-DD 형식
              start.setDate(start.getDate() + 1);
          }
      });

      console.log("비활성화 날짜: ", disabledDates); // 콘솔에서 확인

      // ✅ 체크인 날짜 선택 필드
      let checkInPicker = flatpickr("#checkInDate", {
          dateFormat: "Y-m-d",
          minDate: "today",
          disable: [...disabledDates], // 예약된 날짜 비활성화
          onChange: function (selectedDates) {
              let checkOutPicker = document.getElementById("checkOutDate")._flatpickr;
              if (!selectedDates[0]) return;

              let minCheckOut = selectedDates[0].fp_incr(1);
              checkOutPicker.set("minDate", minCheckOut);
              checkOutPicker.setDate(""); // 체크아웃 초기화
          }
      });

      // ✅ 체크아웃 날짜 선택 필드
      let checkOutPicker = flatpickr("#checkOutDate", {
          dateFormat: "Y-m-d",
          minDate: "today",
          disable: [...disabledDates],
          onChange: function (selectedDates) {
              if (!selectedDates[0]) return;
              let checkInDate = document.getElementById("checkInDate").value;

              if (!checkInDate) {
                  alert("⚠ 체크인 날짜를 먼저 선택하세요!");
                  checkOutPicker.clear();
                  return;
              }

              let startDate = new Date(checkInDate);
              let endDate = selectedDates[0];

              // ✅ 체크인-체크아웃 사이에 예약된 날짜가 있는지 확인
              let invalidDateFound = false;
              let tempDate = new Date(startDate);
              tempDate.setDate(tempDate.getDate() + 1); // 체크인 다음날부터 검사

              while (tempDate <= endDate) {
                  if (disabledDates.has(tempDate.toISOString().split("T")[0])) {
                      invalidDateFound = true;
                      break;
                  }
                  tempDate.setDate(tempDate.getDate() + 1);
              }

              // ✅ 예약된 날짜가 포함된 경우 경고 및 체크인 & 체크아웃 초기화
              if (invalidDateFound) {
                  alert("⚠ 선택한 기간에 예약된 날짜가 포함되어 있습니다. 다른 날짜를 선택해주세요.");
                  checkInPicker.clear();
                  checkOutPicker.clear();
              }
          }
      });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkInInput = document.getElementById("checkInDate");
    const checkOutInput = document.getElementById("checkOutDate");
    const priceDetails = document.getElementById("priceDetails");
    const totalPrice = document.getElementById("totalPrice");
    const finalTotal = document.getElementById("finalTotal");

    const pricePerNight = parseInt([[${room.pricePerNight}]]); // Thymeleaf에서 가격 가져오기

    function updatePrice() {
      const checkInDate = new Date(checkInInput.value);
      const checkOutDate = new Date(checkOutInput.value);

      if (isNaN(checkInDate) || isNaN(checkOutDate) || checkOutDate <= checkInDate) {
        priceDetails.innerText = `₩${pricePerNight} x 1박`;
        totalPrice.innerText = `₩${pricePerNight}`;
        finalTotal.innerText = `₩${pricePerNight}`;
        return;
      }

      // 숙박 일수 계산
      const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

      // 가격 계산
      const total = pricePerNight * nights;

      // 화면 업데이트
      priceDetails.innerText = `₩${pricePerNight} x ${nights}박`;
      totalPrice.innerText = `₩${total}`;
      finalTotal.innerText = `₩${total}`;
    }

    checkInInput.addEventListener("change", updatePrice);
    checkOutInput.addEventListener("change", updatePrice);
  });
</script>

<script>


  function initMap() {
      var roomLocation = {
          lat: parseFloat([[${room.latitude}]]),
          lng: parseFloat([[${room.longitude}]])
      };

      var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 14,
          center: roomLocation
      });

      var marker = new google.maps.Marker({
          position: roomLocation,
          map: map,
          title: '숙소 위치'
      });
  }
</script>

<!--로그인모달-->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const loginModalElement = document.getElementById("loginModal");
    const loginModal = new bootstrap.Modal(loginModalElement);
    const openModalBtn = document.getElementById("openLoginModal");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");

    if (!loginModalElement) {
        console.error("❌ loginModal 요소를 찾을 수 없습니다.");
        return;
    }

    if (!openModalBtn) {
        console.error("❌ 로그인 버튼(#openLoginModal)을 찾을 수 없습니다.");
        return;
    }


    // ✅ 서버에서 렌더링한 유저 정보 가져오기
    const user = /*[[${user}]]*/ null; // Thymeleaf에서 유저 정보 가져오기


    console.log("Thymeleaf에서 받은 사용자 정보:", user);

    // ✅ 로그인 버튼 클릭 시 모달 열기
    openModalBtn.addEventListener("click", function() {
        console.log("로그인 모달 열기 버튼 클릭됨!");
        loginModal.show(); // 모달 열기
    });

    // 🔹 로그인 상태 확인 & UI 업데이트
    function checkAuth() {
      if (user) {
        openModalBtn.classList.add("d-none");
        logoutBtn.classList.remove("d-none");
      } else {
        openModalBtn.classList.remove("d-none");
        logoutBtn.classList.add("d-none");
      }
    }

    // 🔹 로그인 요청
    loginBtn.addEventListener("click", async function() {
      const username = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      console.log("로그인 요청 시작", username, password);

      const response = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      console.log("서버 응답:", response.status);

      if (response.ok) {
        loginModal.hide();
        location.reload(); // ✅ 로그인 성공 후 페이지 새로고침하여 Thymeleaf 변수 반영
      } else {
        console.log("로그인 실패!");
        loginError.textContent = "로그인 실패! 이메일 또는 비밀번호를 확인하세요.";
      }
    });

    // 🔹 로그아웃 기능 (서버에서 세션 제거)
    logoutBtn.addEventListener("click", async function() {
      console.log("로그아웃 실행");

      await fetch("/api/logout", { method: "POST" });
      location.reload(); // ✅ 로그아웃 후 페이지 새로고침하여 UI 업데이트
    });

    checkAuth(); // 페이지 로드 시 로그인 상태 확인
  });
</script>

</body>
</html>
